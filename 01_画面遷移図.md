# MVP 画面遷移図

## 画面一覧と遷移フロー

### 画面ID: `HOME`
**画面名称**: ホーム画面（ダッシュボード）

**主要コンポーネント**
- 今日のタスクカード（推奨レベル表示）
- 進捗サマリー（完了タスク数、弱点タグ推移グラフ）
- クイックアクション（新規タスク開始、単語学習、履歴確認）
- レベル選択ボタン（初級/中級/上級）

**遷移条件**
- 初回訪問時: レベル選択 → `TASK`（選択レベルで遷移）
- 既存ユーザー: 推奨タスクカードクリック → `TASK`
- 単語学習ボタン → `VOCAB`
- 進捗ボタン → `PROGRESS`

**主要API呼び出し**
- `GET /api/tasks/recommended` - 今日の推奨タスク取得
- `GET /api/progress/summary` - 進捗サマリー取得
- `GET /api/user/level` - ユーザーの現在レベル推定

**保存されるデータ**
- なし（表示のみ）

---

### 画面ID: `TASK`
**画面名称**: ライティングタスク画面

**主要コンポーネント**
- お題表示エリア（IELTS形式の質問）
- レベル別ガイド表示
  - 初級: PREP構造ガイド + 必須語彙リスト（3〜5語）
  - 中級: PREP構造ガイド + 必須語彙リスト（3〜5語）
  - 上級: 必須語彙リスト（3〜5語）のみ
- 入力エリア
  - 初級: 日本語回答入力 → 英語骨格表示 → 穴埋め形式入力
  - 中級: 英語PREP構造入力 → 穴埋め形式入力
  - 上級: 英語全文入力（自由記述）
- 保存/送信ボタン

**遷移条件**
- タスク送信 → `FILL_IN`（初級/中級の場合）または `FEEDBACK`（上級の場合）
- ホームに戻る → `HOME`

**主要API呼び出し**
- `GET /api/tasks/:taskId` - タスク詳細取得（お題、レベル、必須語彙）
- `POST /api/tasks/:taskId/submit` - 回答送信
- `POST /api/llm/generate-skeleton` - 初級用：英語骨格生成

**保存されるデータ**
- `user_responses` テーブル
  - `task_id`, `user_id`, `level`, `draft_content` (JSON: 日本語/英語骨格/穴埋め回答)
  - `submitted_at`, `status` ('draft' | 'submitted')

---

### 画面ID: `FILL_IN`
**画面名称**: 穴埋め問題画面（初級/中級のみ）

**主要コンポーネント**
- 弱点タグ別の問題表示（CC / LR / GRA のいずれか1〜3問）
- 穴埋めフォーム（選択式 or 記述式）
- ヒント表示ボタン
- 回答送信ボタン

**遷移条件**
- 回答送信 → `FEEDBACK`
- スキップ（上級ユーザー向け） → `FEEDBACK`

**主要API呼び出し**
- `POST /api/tasks/:taskId/fill-in` - 穴埋め回答送信
- `GET /api/tasks/:taskId/fill-in-questions` - 穴埋め問題生成（弱点別）

**保存されるデータ**
- `fill_in_responses` テーブル
  - `response_id`, `question_type` (CC/LR/GRA), `user_answer`, `is_correct`

---

### 画面ID: `FEEDBACK`
**画面名称**: フィードバック表示画面

**主要コンポーネント**
- 総合Band推定表示（例: "6.0-6.5"）
- 4次元評価カード（TR / CC / LR / GRA）
  - 各次元のBand推定
  - 短評（1〜2文）
  - 根拠となる該当文のハイライト
- 強みセクション（最大2つ）
- Band-up actions（最大3つ、優先順位付き）
  - 各アクションに具体例と次回タスクへのリンク
- 書き直し対象の指定（段落/文ID + 修正方針）
- 語彙提案（言い換え、コロケーション）

**遷移条件**
- 書き直し開始 → `REWRITE`
- Speaking練習へ → `SPEAK`
- 次のタスク → `HOME` または `TASK`（新規）
- 進捗確認 → `PROGRESS`

**主要API呼び出し**
- `POST /api/llm/feedback` - フィードバック生成（LLM呼び出し）
- `GET /api/feedback/:feedbackId` - 保存済みフィードバック取得
- `POST /api/feedback/:feedbackId/save` - フィードバック保存

**保存されるデータ**
- `feedbacks` テーブル
  - `response_id`, `overall_band_range`, `dimensions` (JSON), `strengths` (JSON)
  - `band_up_actions` (JSON), `rewrite_targets` (JSON), `vocab_suggestions` (JSON)
  - `created_at`
- `user_progress` テーブル（更新）
  - `weakness_tags` (TR/CC/LR/GRA の配列), `latest_band_estimate`

---

### 画面ID: `REWRITE`
**画面名称**: ガイド付き書き直し画面

**主要コンポーネント**
- 元の回答表示（全体）
- 書き直し対象のハイライト表示（`rewrite_targets`で指定された段落/文）
- 修正方針の表示（各対象ごと）
- 編集可能エリア（指定範囲のみ編集可能、他は読み取り専用）
- 全文書き換え防止の警告表示
- 再評価ボタン

**遷移条件**
- 再評価送信 → `FEEDBACK`（更新版）
- キャンセル → `FEEDBACK`（元の画面に戻る）

**主要API呼び出し**
- `POST /api/tasks/:taskId/rewrite` - 書き直し回答送信
- `POST /api/llm/feedback` - 再評価（既存フィードバックIDを指定）

**保存されるデータ**
- `user_responses` テーブル（更新）
  - `rewritten_content`, `rewrite_count`, `status` ('rewritten')
- `feedbacks` テーブル（新規レコード）
  - `parent_feedback_id` (前回のフィードバックID), `is_rewrite` (true)

---

### 画面ID: `SPEAK`
**画面名称**: Speaking練習画面

**主要コンポーネント**
- 2分要約プロンプト表示（Writingタスクの要約）
- Follow-up質問5問（順次表示 or 一覧表示）
- 必須語彙リスト（タスクで使用した語彙 + 新規3〜5語）
- 回答入力エリア（テキストのみ、MVPでは音声録音なし）
- 音読プロンプト表示（「この内容を2分で音読してください」）
- 録音ボタン（MVPでは非表示 or プレースホルダー）

**遷移条件**
- 完了 → `HOME` または `PROGRESS`
- タスクに戻る → `FEEDBACK`

**主要API呼び出し**
- `POST /api/llm/generate-speaking-prompt` - Speakingプロンプト生成
- `GET /api/speaking/:taskId/prompts` - 保存済みプロンプト取得

**保存されるデータ**
- `speaking_prompts` テーブル
  - `task_id`, `summary_prompt`, `follow_up_questions` (JSON), `required_vocab` (JSON)
  - `created_at`
- `speaking_responses` テーブル（MVPではテキストのみ）
  - `prompt_id`, `user_id`, `text_response`, `completed_at`

---

### 画面ID: `VOCAB`
**画面名称**: 単語学習画面

**主要コンポーネント**
- 今日の必須語彙カード（タスクで使用する語彙）
- 選択式問題10問（4技能タグ付き）
  - 問題形式: 英→日、日→英、文脈埋め込み、コロケーション
- 進捗バー（10問中X問完了）
- 結果表示（正答率、間違えた語彙リスト）

**遷移条件**
- タスクから遷移: 今日の必須語彙を優先表示
- 独立アクセス: 全語彙からランダム10問
- 完了後 → `HOME` または `TASK`（必須語彙を学習済みとして表示）

**主要API呼び出し**
- `GET /api/vocab/today-required` - 今日の必須語彙取得
- `GET /api/vocab/questions` - 選択式問題生成（10問）
- `POST /api/vocab/submit` - 回答送信
- `GET /api/vocab/:vocabId` - 語彙詳細（例文、コロケーション）

**保存されるデータ**
- `vocab_study_sessions` テーブル
  - `user_id`, `session_date`, `questions` (JSON), `answers` (JSON), `score`
- `user_vocab_progress` テーブル
  - `user_id`, `vocab_id`, `mastery_level`, `last_studied_at`, `next_review_at`

---

### 画面ID: `PROGRESS`
**画面名称**: 進捗・履歴画面

**主要コンポーネント**
- 弱点タグ推移グラフ（TR/CC/LR/GRA の時系列）
- タスク履歴リスト（日付、レベル、Band推定、弱点タグ）
- フィルター（レベル、期間、弱点タグ）
- 各タスクの詳細リンク（フィードバック再表示）

**遷移条件**
- タスク詳細クリック → `FEEDBACK`（過去のフィードバック表示）
- ホームに戻る → `HOME`

**主要API呼び出し**
- `GET /api/progress/history` - タスク履歴取得
- `GET /api/progress/weakness-trend` - 弱点推移データ取得
- `GET /api/progress/stats` - 統計情報（総タスク数、平均Bandなど）

**保存されるデータ**
- なし（表示のみ、既存データを集計）

---

## 認証・初期設定フロー

### 画面ID: `AUTH`
**画面名称**: 認証画面（ログイン/サインアップ）

**主要コンポーネント**
- メール/パスワード入力
- サインアップ時: 初期レベル選択（初級/中級/上級）

**遷移条件**
- 認証成功 → `HOME`
- 未認証ユーザーは全画面で `AUTH` にリダイレクト

**主要API呼び出し**
- Supabase Auth（クライアント側）

**保存されるデータ**
- `users` テーブル（Supabase Auth連携）
  - `id`, `email`, `initial_level`, `created_at`

---

## データフロー概要

### タスク生成フロー
1. `HOME` → レベル選択
2. `GET /api/tasks/generate` → LLMでタスク生成（キャッシュ可能）
3. `TASK` 画面表示

### フィードバック生成フロー
1. `TASK` → 回答送信
2. `FILL_IN`（初級/中級のみ）→ 穴埋め回答
3. `POST /api/llm/feedback` → LLMでフィードバック生成
4. フィードバックJSONを `feedbacks` テーブルに保存
5. `FEEDBACK` 画面表示

### 書き直しフロー
1. `FEEDBACK` → 書き直し開始
2. `REWRITE` → 指定範囲のみ編集
3. `POST /api/tasks/:taskId/rewrite` → 再評価
4. `FEEDBACK`（更新版）表示

### Speaking連携フロー
1. `FEEDBACK` → Speaking練習へ
2. `POST /api/llm/generate-speaking-prompt` → プロンプト生成
3. `SPEAK` 画面表示

---

## 技術的な遷移制約

- 未認証ユーザー: `AUTH` 以外の全画面でリダイレクト
- タスク未選択: `TASK` 以外の学習画面（`FILL_IN`, `FEEDBACK`, `REWRITE`, `SPEAK`）はアクセス不可
- レベル別制御: 初級/中級は `FILL_IN` 必須、上級はスキップ可能
- 書き直し制限: `REWRITE` は `FEEDBACK` からしか遷移不可、最大3回まで

