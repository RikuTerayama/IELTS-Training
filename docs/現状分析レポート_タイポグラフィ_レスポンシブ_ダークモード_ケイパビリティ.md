# 現状分析レポート：タイポグラフィ・レスポンシブ・ダークモード・ケイパビリティ

**作成目的**: G1〜G5 要件を満たすための現状把握・原因特定・設計方針案・優先順位付けの材料化。  
**制約**: コード変更は一切行わない（調査・文書化のみ）。

---

## 1. 重要結論サマリ

- **タイポグラフィ**: `tailwind.config.ts` に用途別トークン（display, heading-1/2/3, body, small, ui）が定義されているが、**実際の参照はゼロ**。各ページは `text-xs` / `text-sm` / `text-base` / `text-lg` / `text-xl` / `text-2xl` / `text-3xl` / `text-5xl` / `text-7xl` を手打ちしており、**ページ間でサイズがバラバラ**。同じ役割（例：セクション見出し）でも `text-2xl` と `text-3xl` が混在。
- **レスポンシブ**: `app/globals.css` で `html { overflow-x: hidden }` を設定済み。h1〜h6, p, li に `overflow-wrap: break-word` あり。一方、`whitespace-nowrap`（`app/task/[taskId]/page.tsx` L543）がボタンに付いており、狭い幅でははみ出しの可能性。flex 子に `min-w-0` を付けているのは `app/home/page.tsx` の grid のみ。長い英単語・URL を想定した `break-words` は globals の見出し・本文に限定で、カード内テキストやボタン文言には明示なし（推測：globals の p/li 継承で一部カバーされる想定）。
- **ダークモード**: `data-theme="dark"` 方式で `app/globals.css` に `[data-theme="dark"]` で `--bg: 7 12 24` 等を定義。**LP は `bg-[#FAFAFA]` をハードコードしており、ダークモードでも常にライト背景**。`Layout`（`components/layout/Layout.tsx`）、`login`（`app/(auth)/login/page.tsx`）も `bg-[#FAFAFA]` 固定。`lib/ui/theme.ts` の cardBase は `bg-white` / `border-slate-200` で Tailwind 固定色を使用し、CSS 変数を使っていない。**LP・認証・Layout 配下はダークモード時に背景が十分暗くならない**。
- **ケイパビリティ**: 主要ルートは LP（/）、Auth（/login, /onboarding）、Home（/home）、Input（/training/vocab, idiom, lexicon）、Output（/training/speaking, /task/select）、Task（/task/[taskId], prep）、Feedback（/feedback/[attemptId]）、Fill-in、Progress 等。API は `/api/menu/today`, `/api/input/items`, `/api/tasks/*`, `/api/output/submit`, `/api/llm/*`, Supabase 連携等。**リスク**：Supabase 未設定時のビルド・静的生成失敗、LLM 制限・コスト、認可漏れの可能性、エラー時のフォールバック不足、LP のハードコード色によるダークモード無効化。

---

## 2. 現状アーキテクチャ（UI 観点）

### 2.1 Tailwind / スタイル方式

- **Tailwind**: `tailwind.config.ts` で `content` に `pages/`, `components/`, `app/` を指定。`theme.extend` に `fontSize`（display, heading-1〜3, body, body-lg, small, ui, ui-sm）、`colors`（bg, text, primary, accent, danger, success, warning 等、CSS 変数ベース）、`boxShadow`（theme, theme-lg）を定義。
- **共通クラス**: `lib/ui/theme.ts` で `cardBase`, `cardTitle`, `cardDesc`, `textareaBase`, `buttonPrimary`, `buttonSecondary` 等を提供。これらは `border-slate-200` / `bg-white` / `text-slate-900` 等の Tailwind 固定色を使用。
- **prose / container**: `tailwind.config.ts` に `prose` や `container` のカスタム定義はない。`container` は Tailwind デフォルト（`max-width` がブレークポイントで変わる）を使用。

### 2.2 ダークモード方式

- **方式**: `data-theme` 属性方式。`app/layout.tsx` の `<html>` に、クライアントで `document.documentElement.setAttribute('data-theme', resolvedTheme)` を実行。
- **globals.css**: `:root` でライト用、`[data-theme="dark"]` でダーク用の CSS 変数（`--bg`, `--text`, `--border` 等）を定義。ダーク背景は `--bg: 7 12 24`（rgb(7,12,24) 相当）で十分暗い。
- **問題**: LP・Layout・login は `bg-[#FAFAFA]` を直接指定しており、`--bg` を参照していない。そのため **data-theme="dark" になってもこれらのページはライト背景のまま**。

### 2.3 主要ページ一覧（パス → 実体ファイル）

| パス | 実体 |
|------|------|
| / | `app/page.tsx` |
| /login | `app/(auth)/login/page.tsx` |
| /onboarding | `app/onboarding/page.tsx` |
| /home | `app/home/page.tsx` |
| /task/select | `app/task/select/page.tsx` |
| /task/[taskId] | `app/task/[taskId]/page.tsx` |
| /task/[taskId]/prep | `app/task/[taskId]/prep/page.tsx` |
| /training/vocab | `app/training/vocab/page.tsx` |
| /training/idiom | `app/training/idiom/page.tsx` |
| /training/lexicon | `app/training/lexicon/page.tsx` |
| /training/speaking | `app/training/speaking/page.tsx` |
| /training/speaking/task{1,2,3}/drill | `app/training/speaking/task{1,2,3}/drill/page.tsx` |
| /training/writing/task1 | `app/training/writing/task1/page.tsx` |
| /feedback/[attemptId] | `app/feedback/[attemptId]/page.tsx` |
| /fillin/[attemptId] | `app/fillin/[attemptId]/page.tsx` |
| /rewrite/[attemptId] | `app/rewrite/[attemptId]/page.tsx` |
| /progress | `app/progress/page.tsx` |

---

## 3. タイポグラフィ現状と問題類型

### 3.1 文字サイズ分布（多いクラス、例外）

- **tailwind.config.ts の fontSize トークン**: `text-display`, `text-heading-1`, `text-body`, `text-small` 等を定義しているが、**grep で参照ゼロ**。
- **実際の使用**: 以下のようなクラスが手打ちで使われている（grep 結果から）。

| クラス | 主な使用箇所 | 用途例 |
|--------|--------------|--------|
| text-xs | Header, LP, task, prep, feedback 等 | ラベル、Coming soon、バッジ、注釈 |
| text-sm | 多数 | ナビ、本文、説明、フッター、フォーム |
| text-base | task page | 質問文、本文 |
| text-lg | LP, task, prep, feedback, Privacy/Terms | サブコピー、モーダル見出し |
| text-xl | LP, home, task, prep, Header | カード見出し、セクション小見出し |
| text-2xl | LP, task, feedback, prep, home | セクション見出し、モーダル |
| text-3xl | LP, login | セクション大見出し |
| text-4xl | home | ページタイトル |
| text-5xl | LP | ヒーロー価格、ヒーロー見出し（lg:text-7xl） |
| text-7xl | LP（lg:） | ヒーロー見出し |

- **問題**: 同じ「セクション見出し」でも LP は `text-3xl`、home は `text-2xl`、task は `text-2xl` と `text-xl` 混在。**ページごとにサイズが異なり、一貫したスケールになっていない**。

### 3.2 行間・字間の不整合

- **leading-relaxed**: LP, task, home, feedback 等で使用。本文や説明文に多用。
- **leading-[1.1]**: LP ヒーロー見出し（`h1`）のみ。他と異なる。
- **leading-relaxed 未指定**: 多数の `p` や `h3` で行間が指定されておらず、body デフォルト（1.6）に依存。
- **tracking-tight**: 見出しに多用（`text-xl`, `text-2xl`, `text-3xl`）。
- **tracking-tighter**: LP ヒーロー `h1` のみ。
- **tracking-wide**, **tracking-wider**: ラベル（uppercase）に使用。
- **問題**: 見出しと本文の行間・字間が用途ごとに統一されておらず、**同じ役割でもクラスがばらついている**。

### 3.3 主要ページ比較（抜粋付き）

| ページ | メイン見出し | サブ見出し/カード見出し | 本文/説明 |
|--------|--------------|-------------------------|-----------|
| LP | `text-5xl lg:text-7xl tracking-tighter leading-[1.1]` | `text-3xl`（セクション）, `text-xl`（カード） | `text-lg`（ヒーロー）, `text-slate-500 text-lg`（サブ）, `text-slate-600 text-sm leading-relaxed`（カード） |
| home | `text-4xl font-bold tracking-tight` | `text-2xl font-bold tracking-tight` | `text-sm text-slate-600 leading-relaxed` |
| task | `text-2xl font-bold tracking-tight` | `text-xl`, `text-sm font-semibold uppercase tracking-wider` | `text-base text-slate-700 leading-relaxed`, `text-sm` |
| prep | `text-lg font-semibold`（cardTitle） | `text-sm font-semibold uppercase tracking-wider` | `text-sm`（cardDesc）, `text-lg`（評価） |
| feedback | `text-2xl font-bold tracking-tight` | `text-sm font-semibold uppercase tracking-wider` | `text-sm text-slate-700 leading-relaxed` |
| login | `text-3xl font-bold tracking-tight` | - | `text-sm`, `text-xs` |

- **結論**: セクション見出しが LP で `text-3xl`、home で `text-2xl`、task で `text-2xl` / `text-xl` と不統一。本文も `text-sm` / `text-base` / `text-lg` が混在し、**ページ間でフォーマットが揃っていない**。

---

## 4. レスポンシブ問題の現状と原因候補

### 4.1 横スクロール原因の候補一覧（根拠コード）

| 候補 | 根拠 | ファイル |
|------|------|----------|
| html overflow-x: hidden | 横スクロール防止のため明示済み | `app/globals.css` L130〜132 |
| 固定幅装飾 | `w-[1000px]`, `w-[800px]` 等の装飾用 div が `overflow-hidden` 親内 | `app/page.tsx` L240〜241, `app/(auth)/login/page.tsx` L222〜223 |
| whitespace-nowrap | ボタンに `whitespace-nowrap` 指定 | `app/task/[taskId]/page.tsx` L543: `className={cn('...', 'whitespace-nowrap')}` |
| min-w-[140px] 等 | ドロップダウンに固定 min-width | `components/layout/Header.tsx` L89, L116, L143 |

- **whitespace-nowrap**: ボタン文言が長い場合、狭い幅（例: 320px）で横にはみ出す可能性あり。根拠: `app/task/[taskId]/page.tsx` の Submit ボタンに付与。
- **min-w-[140px]**: ドロップダウン幅は固定だが、親が `overflow-hidden` でなければ問題になりにくい。Header は `container` 内なので、container 幅を超えなければ横スクロールは起こりにくい（推測）。

### 4.2 はみ出しが起きやすいコンポーネント一覧（根拠コード）

| コンポーネント | 原因候補 | 根拠 |
|----------------|----------|------|
| task page の Submit ボタン | `whitespace-nowrap` | `app/task/[taskId]/page.tsx` L543 |
| 長い英単語・URL | カード内・ボタン内に `break-words` なし | globals の h1〜h6, p, li には `overflow-wrap: break-word` あり。カード内の `div` や `span` は継承する場合もあるが、flex 子などでははみ出す可能性（要確認） |
| ユーザーメール表示 | 長いメールアドレス | Header の `text-sm text-slate-500`、truncate なし。`components/layout/Header.tsx` L175 |
| カード内テキスト | flex 子に `min-w-0` なし | `app/home/page.tsx` の grid には `min-w-0` あり（L192, L206）。他ページの grid/flex 子は未確認 |
| iframe（Contact） | 幅 100% で高さ固定 | `app/page.tsx` の Google Forms iframe。親が `max-w-3xl` なので、親幅を超えなければ問題になりにくい（推測） |

### 4.3 代表幅（320, 375, 768, 1024）で崩れやすい候補

- **320px**: ドロップダウン `min-w-[140px]` は収まる。LP ヒーロー `text-5xl` は大きいが折り返し想定。`whitespace-nowrap` ボタンが最も怪しい。
- **375px**: 同様。container の padding（px-6 = 24px×2）を差し引いた幅でコンテンツが収まるかは要確認。
- **768px, 1024px**: container の max-width が効き、通常は問題になりにくい（推測）。

---

## 5. ダークモード問題の現状と原因候補

### 5.1 背景が十分暗くない根拠

- **globals.css**: `[data-theme="dark"]` で `--bg: 7 12 24`（rgb(7,12,24)）を定義。これは十分暗い。
- **body**: `@apply bg-[rgb(var(--bg))]` で `--bg` を参照しているため、**body 自体はダークモードで暗くなる**。
- **問題**: LP（`app/page.tsx`）は `min-h-screen bg-[#FAFAFA]` をルート div に指定（L236）。Layout（`components/layout/Layout.tsx`）は `bg-[#FAFAFA]`（L6）。login（`app/(auth)/login/page.tsx`）は `bg-[#FAFAFA]`（L219）。これらは **CSS 変数を参照せず、常にライト背景**。そのため、`data-theme="dark"` になっても LP・認証・Layout 配下のページは背景が白っぽいまま。

### 5.2 LP だけ別配色になっている可能性

- **LP**: `bg-[#FAFAFA]` を多用。`app/page.tsx` で L236（ルート）, L438, L449, L460（課題解決カード）, L475（Features セクション）, L615（About 内）, L662（Contact セクション）。
- **Layout**: `components/layout/Layout.tsx` L6 で `bg-[#FAFAFA]`。
- **login**: `app/(auth)/login/page.tsx` L219 で `bg-[#FAFAFA]`。
- **結論**: LP だけでなく、Layout と login も `#FAFAFA` 固定。**テーマ変数（--bg-secondary 等）を使わず、ライト専用のハードコードになっている**。

### 5.3 theme.ts の cardBase 等

- `lib/ui/theme.ts` の `cardBase` は `bg-white border-slate-200`。CSS 変数の `surface` / `border` を使っていない。
- そのため、**ダークモード時にカードも白背景のまま**。可読性・コントラストの観点でダークモードが正しく効いていない。

---

## 6. 推奨する設計方針案（まだ実装しない）

### 6.1 タイポグラフィスケール案

| 用途 | 案 | 備考 |
|------|-----|------|
| Display | `text-display`（既存） | ヒーロー等。clamp でレスポンシブ |
| H1 | `text-heading-1`（既存） | ページタイトル |
| H2 | `text-heading-2`（既存） | セクション見出し |
| H3 | `text-heading-3`（既存） | カード見出し・小見出し |
| Body | `text-body` または `text-body-lg`（既存） | 本文 |
| Small | `text-small`（既存） | 注釈・補足 |
| UI | `text-ui` または `text-ui-sm`（既存） | ナビ・ボタン・ラベル |

- **方針**: 既存の tailwind fontSize トークンを実際に使用し、手打ちの `text-xl` 等を段階的に置き換える。ページ間で「H2 は text-heading-2」のように統一する。

### 6.2 レスポンシブの基本対策セット案

- **min-w-0**: flex/grid の子要素でテキストがはみ出しうる場合に付与。
- **break-words** / **overflow-wrap: break-word**: 長い英単語・URL を含むブロックに適用。globals の p, li に続き、カード内テキストやボタン文言にも必要に応じて適用。
- **whitespace-nowrap の見直し**: ボタン等で狭い幅ではみ出す可能性がある場合は削除または `sm:whitespace-nowrap` に変更。
- **container**: 既存の `container mx-auto px-4` または `px-6` を維持。必要に応じて `max-w-*` でセクションごとに制限。
- **truncate**: 長いメールアドレス等、はみ出しを防ぎたい箇所に検討。

### 6.3 ダーク配色トークン案

- **背景**: `--bg`, `--bg-secondary` を LP・Layout・login のルートで使用。`bg-[#FAFAFA]` を `bg-[rgb(var(--bg))]` または `bg-bg` に置き換え。
- **カード**: `cardBase` を `bg-surface border-border` に変更し、`--surface`, `--border` を参照。
- **テキスト**: `text-slate-900` を `text-text` に、`text-slate-600` を `text-text-muted` に置き換え（既存の Tailwind colors で CSS 変数マッピング済み）。
- **境界線**: `border-slate-200` を `border-border` に統一。

---

## 7. ケイパビリティ一覧（機能一覧、依存先、データ流れ）

### 7.1 主要ルートと機能

| ルート | 機能 | 依存 API | 依存 DB（想定） |
|--------|------|----------|-----------------|
| / | LP、サインアップ/ログイン | Supabase Auth | - |
| /login | ログイン | Supabase Auth | - |
| /onboarding | 目的ヒアリング | Supabase | profiles |
| /home | 今日のメニュー、Input/Output 導線 | /api/menu/today | lexicon_srs_state, profiles |
| /task/select | タスク選択 | /api/tasks/generate | tasks |
| /task/[taskId] | タスク実施（Task1/2） | /api/tasks/[id], /api/input/items, /api/output/submit | tasks, attempts, lexicon_* |
| /task/[taskId]/prep | PREP ヒアリング | /api/tasks/[id], /api/llm/prep-evaluation, prep-to-essay | tasks |
| /training/vocab, idiom, lexicon | 語彙・熟語・表現学習 | /api/lexicon/* | lexicon_* |
| /training/speaking/* | Speaking 練習 | /api/input/items | lexicon_* |
| /feedback/[attemptId] | フィードバック表示 | /api/attempts, /api/feedback/attempt, /api/llm/feedback | attempts, feedback |
| /fillin/[attemptId] | 穴埋め | /api/tasks/[id]/fill-in-questions, fill-in | attempts |
| /rewrite/[attemptId] | 書き直し | /api/tasks/[id]/rewrite | attempts, feedback |
| /progress | 進捗 | /api/progress/history, summary | - |

### 7.2 データ流れ（簡略）

- **認証**: Supabase Auth → session/cookies → middleware でガード。
- **メニュー**: /api/menu/today → lexicon_srs_state の Due 件数等 → input/output カード生成。
- **タスク**: /api/tasks/generate（LLM）→ タスク作成 → /api/input/items で推奨表現取得 → ユーザー実施 → /api/tasks/[id]/submit → /api/output/submit で使用チェック。
- **フィードバック**: attempts → /api/llm/feedback → フィードバック生成・保存。

---

## 8. リスク棚卸し（重大度、影響、対策案、優先順位）

| 観点 | リスク | 重大度 | 影響 | 対策案 | 優先順位案 |
|------|--------|--------|------|--------|------------|
| セキュリティ | 認可漏れ（他ユーザー attempt 参照等） | 中 | 情報漏洩 | attempt_id に user_id 紐付け確認、API で所有者チェック | 高 |
| セキュリティ | 入力検証不足（XSS、インジェクション） | 中 | 脆弱性 | 出力のエスケープ、LLM 入力のサニタイズ | 中 |
| 信頼性 | Supabase 未設定時のビルド失敗 | 高 | デプロイ不可 | 静的生成時は API をスキップ、または env チェックで早期 return | 高 |
| 信頼性 | LLM API 失敗時のフォールバック不足 | 中 | UX 悪化 | エラー時にフォールバック表示、リトライ案内 | 中 |
| 信頼性 | 外部 API（Groq, OpenAI）制限・障害 | 中 | 機能停止 | レート制限、エラーハンドリング、フォールバック | 中 |
| コスト | LLM API 連打・制限なし | 中 | コスト増 | クライアント側の連打防止、API 側のレート制限 | 中 |
| データ整合性 | ルート重複（/vocab, /training/writing/task2） | 低 | 混乱 | middleware で 308 リダイレクト（既存） | 低 |
| UX/アクセシビリティ | 文字サイズ不統一 | 中 | 読みづらさ | タイポグラフィスケールの適用 | 高 |
| UX/アクセシビリティ | ダークモードが LP/Layout で効かない | 中 | 可読性 | #FAFAFA を CSS 変数参照に置換 | 高 |
| UX/アクセシビリティ | コントラスト不足（ダーク時） | 低 | 可読性 | トークン調整、WCAG 確認 | 中 |
| 保守性 | タイポトークン未使用 | 中 | 一貫性低下 | text-display, text-heading-* 等の採用 | 高 |
| 保守性 | ハードコード色（#FAFAFA 等） | 中 | テーマ破綻 | CSS 変数・theme トークンへの移行 | 高 |

---

## 9. 直近でやるべき改善トップ 5（理由付き）

1. **LP・Layout・login の背景を CSS 変数参照に変更**  
   - 理由: ダークモードが全く効いておらず、ユーザー期待に反する。`bg-[#FAFAFA]` → `bg-bg` または `bg-[rgb(var(--bg))]` への置換で、テーマ切り替えが有効になる。
2. **タイポグラフィトークンの採用**  
   - 理由: display, heading-1〜3, body, small が定義済みなのに未使用。セクション見出し等を `text-heading-2` 等に統一し、一貫したスケールにする。
3. **theme.ts の cardBase 等を CSS 変数参照に変更**  
   - 理由: `bg-white` / `border-slate-200` のままだとダークモード時にカードが白のまま。`bg-surface` / `border-border` にすることでダークモード対応になる。
4. **whitespace-nowrap の見直し**  
   - 理由: task の Submit ボタンが狭い幅ではみ出す可能性。削除またはレスポンシブ付与（`sm:whitespace-nowrap`）で対処。
5. **Supabase 未設定時のビルド堅牢化**  
   - 理由: 静的生成で API が叩かれると「Dynamic server usage」等で失敗する。env 未設定時は API を早期 return する等で、ビルドが通るようにする。

---

## 10. 次工程（実装）で触るべきファイル候補一覧

| カテゴリ | ファイル |
|----------|----------|
| タイポグラフィ | `app/page.tsx`, `app/home/page.tsx`, `app/task/[taskId]/page.tsx`, `app/task/[taskId]/prep/page.tsx`, `app/feedback/[attemptId]/page.tsx`, `app/(auth)/login/page.tsx`, `components/layout/Header.tsx` |
| レスポンシブ | `app/task/[taskId]/page.tsx`（whitespace-nowrap）, `app/globals.css`（必要なら break-words 拡張） |
| ダークモード | `app/page.tsx`, `components/layout/Layout.tsx`, `app/(auth)/login/page.tsx`, `lib/ui/theme.ts` |
| ケイパビリティ/リスク | `app/api/**/*.ts`（エラーハンドリング、認可確認）, `middleware.ts` |
| 設定 | `tailwind.config.ts`（既存トークンの確認・微調整）, `app/globals.css` |

---

以上。
