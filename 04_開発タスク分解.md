# 開発タスク分解（1〜2ヶ月PoC実装）

## 全体スケジュール（縦スライス優先）

### 縦スライス実装順序

PoCでは機能を横に広げず、以下の縦スライスを完成させてから次へ進む：

#### 縦スライス1: Login → Home → Task → Submit → Feedback → Progress
**目標**: 基本的なWritingタスクの流れを完成させる

**実装内容**:
- 認証機能（Supabase Auth）
- HOME画面（推奨タスク表示、弱点タグ表示）
- TASK画面（お題表示、レベル別入力、必須語彙）
- タスク生成API（LLM連携）
- 回答送信API
- フィードバック生成API（LLM連携）
- FEEDBACK画面（Band推定、4次元評価、Band-up actions）
- PROGRESS画面（履歴一覧、弱点タグ推移テキスト表示）
- 進捗トラッキング（daily_state更新）

**完了条件**: 
- ユーザーがログイン → タスク選択 → 回答提出 → フィードバック表示 → 履歴確認まで一通り動作
- データが正しく保存・表示される

---

#### 縦スライス2: Fill-in → Feedback反映
**目標**: 初級/中級向け穴埋め問題を追加

**実装内容**:
- FILL_IN画面（選択式問題、最大3問）
- 穴埋め問題生成（LLM or 簡易ルール）
- 穴埋め回答送信API
- フィードバック生成時に穴埋め結果を反映（band_up_actionsが変わる）

**完了条件**:
- 初級/中級ユーザーが穴埋め問題を解ける
- 穴埋め結果がフィードバックに反映される

---

#### 縦スライス3: Rewrite → Re-evaluate → Feedback更新
**目標**: 書き直し機能を追加

**実装内容**:
- REWRITE画面（2カラム表示、指定範囲のみ編集）
- 書き直し送信API
- 再評価API（rewrite_coachプロンプト）
- フィードバック更新表示

**完了条件**:
- ユーザーが指定範囲のみ書き直せる
- 再評価でフィードバックが更新される
- 最大2箇所、最大3回までの制限が機能する

---

#### 縦スライス4: Vocab → 今日の必須語彙連動
**目標**: 単語学習機能を追加し、タスクと連動

**実装内容**:
- VOCAB画面（選択式10問）
- 単語問題生成API
- 単語学習ログ保存
- 今日の必須語彙をdaily_stateに反映
- TASK/Speak画面で必須語彙を表示

**完了条件**:
- ユーザーが10問の単語問題を解ける
- 学習した語彙が「今日の必須語彙」として表示される
- タスク画面で必須語彙が表示される

---

#### 縦スライス5: Speak（テキストプロンプトのみ）
**目標**: Speaking練習プロンプトを追加

**実装内容**:
- SPEAK画面（2分要約、Follow-up 5問、必須語彙表示）
- Speakingプロンプト生成API（writing_to_speaking）
- プロンプト表示（録音機能はPhase2）

**完了条件**:
- フィードバック画面からSpeaking練習へ遷移できる
- プロンプトが正しく表示される

---

### 週次マイルストーン（縦スライスベース）

#### 第1週: 基盤構築 + 縦スライス1（前半）
- プロジェクトセットアップ（Next.js + TypeScript + Supabase）
- 認証機能実装
- データベース設計・テーブル作成（最小構成8テーブル）
- 共通レイアウト（Header/Footer）
- HOME画面（基本）
- TASK画面（基本）

#### 第2週: 縦スライス1（後半）
- タスク生成API（LLM連携）
- 回答送信API
- フィードバック生成API（LLM連携）
- FEEDBACK画面
- PROGRESS画面（基本）
- 進捗トラッキング

#### 第3週: 縦スライス2
- FILL_IN画面
- 穴埋め問題生成・表示
- 穴埋め回答送信API
- フィードバック反映ロジック

#### 第4週: 縦スライス3
- REWRITE画面（2カラム表示）
- 書き直し送信API
- 再評価API（rewrite_coach）
- フィードバック更新表示

#### 第5週: 縦スライス4
- VOCAB画面
- 単語問題生成API
- 単語学習ログ保存
- 必須語彙連動機能

#### 第6週: 縦スライス5 + 統合
- SPEAK画面（テキストプロンプトのみ）
- Speakingプロンプト生成API
- 全機能の統合テスト
- UI/UX改善

#### 第7〜8週: バグ修正・リリース準備
- バグ修正
- エラーハンドリング強化
- パフォーマンス最適化
- ドキュメント整備
- デプロイ準備
- ユーザーテスト

---

## データベース設計（Supabase Postgres - 最小構成）

詳細は `05_DBテーブル設計_最小構成.md` を参照。

### テーブル一覧（8テーブル）

1. **profiles** - ユーザープロファイル（auth.users参照）
2. **tasks** - タスク（お題）
3. **attempts** - ユーザーの回答（旧user_responses）
4. **feedbacks** - フィードバック
5. **revisions** - 書き直し履歴
6. **vocab_items** - 語彙マスタ（旧vocab_master）
7. **vocab_logs** - 語彙学習ログ（旧vocab_study_sessions）
8. **daily_state** - 今日の状態（推奨タスク、必須語彙、弱点タグ）

### RLS方針（最小ルール）

- 基本は `user_id = auth.uid()` のみ許可
- tasks, vocab_items は全員閲覧可能
- その他は自分のデータのみアクセス可能

詳細なDDLとRLSポリシーは `05_DBテーブル設計_最小構成.md` を参照。

---

## API設計（Next.js Route Handlers - 統一フォーマット）

詳細は `08_API設計_統一フォーマット.md` を参照。

### 共通レスポンス形式

全APIレスポンスは以下の形式に統一：

```typescript
interface ApiResponse<T> {
  ok: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
  };
}
```

### 主要APIエンドポイント

#### タスク関連
- `GET /api/tasks/recommended` - 今日の推奨タスク取得
- `GET /api/tasks/:taskId` - タスク詳細取得
- `POST /api/tasks/generate` - タスク生成（LLM呼び出し）
- `POST /api/tasks/:taskId/submit` - 回答送信

#### フィードバック関連
- `POST /api/llm/feedback` - フィードバック生成（LLM呼び出し）
- `GET /api/feedback/:feedbackId` - 保存済みフィードバック取得

#### 穴埋め関連
- `GET /api/tasks/:taskId/fill-in-questions` - 穴埋め問題生成
- `POST /api/tasks/:taskId/fill-in` - 穴埋め回答送信

#### 書き直し関連
- `POST /api/tasks/:taskId/rewrite` - 書き直し回答送信・再評価

#### Speaking関連
- `POST /api/llm/generate-speaking-prompt` - Speakingプロンプト生成

#### 単語学習関連
- `GET /api/vocab/today-required` - 今日の必須語彙取得
- `GET /api/vocab/questions` - 選択式問題生成（10問）
- `POST /api/vocab/submit` - 回答送信

#### 進捗関連
- `GET /api/progress/summary` - 進捗サマリー取得
- `GET /api/progress/history` - タスク履歴取得
- `GET /api/progress/weakness-trend` - 弱点推移データ取得

### LLM呼び出し

詳細は `07_LLMプロンプトテンプレート.md` を参照。

4種類のプロンプトテンプレート：
1. `task_generate` - タスク生成
2. `writing_feedback` - フィードバック生成
3. `rewrite_coach` - 書き直しコーチ
4. `writing_to_speaking` - Writing→Speakingプロンプト生成

すべてのLLM出力は必ずJSON形式（`schema_version` を含む）。

---

## 画面ごとの主要コンポーネント案

詳細なUI配置（ワイヤー）は `01_画面遷移図_UI配置詳細.md` を参照。

### 共通レイアウト

全画面で共通のレイアウト構造：
- **Header**: アプリ名 / メニュー（Home, Progress, Vocab） / ログイン状態
- **Main**: コンテンツ（画面ごと）
- **Footer**: 今日の進捗（mini） + 次のおすすめ

### 主要画面のコンポーネント

#### HOME画面
- `RecommendedTaskCard` - 今日のおすすめ（レベル、所要時間、Startボタン）
- `WeaknessTagsCard` - 弱点タグ表示（上位1〜2）
- `QuickActionButtons` - Choose level / Vocab 10問

#### TASK画面
- `TaskQuestion` - お題表示
- `TargetBand` - 目標Band表示
- `RequiredVocabList` - 必須語彙（3〜5語）
- `PrepGuide` - PREPガイド（初級/中級のみ）
- `ResponseInput` - レベル別入力フォーム
- `SubmitButton` - 提出ボタン

#### FILL_IN画面
- `FillInQuestion` - 選択式問題（4択、最大3問）
- `CheckAnswersButton` - 回答確認ボタン

#### FEEDBACK画面
- `OverallBandRange` - 総合Band推定
- `BandUpActions` - 最大3つの行動（title, why, how, example）
- `DimensionFeedback` - TR/CC/LR/GRA 各1行の短評（長文禁止）
- `ActionButtons` - Rewrite / Speak

#### REWRITE画面
- `OriginalText` - 原文表示（読み取り専用）
- `EditableSections` - 編集可能エリア（最大2箇所）
- `RewriteGuidance` - 修正方針表示
- `ReevaluateButton` - 再評価ボタン

#### SPEAK画面
- `SummaryPrompt` - 2分要約プロンプト
- `FollowUpQuestions` - Follow-up質問5問
- `RequiredVocabList` - 必須語彙（3〜5語）
- `DoneButton` - 完了ボタン
- ※録音ボタンは作らない（Phase2）

#### VOCAB画面
- `QuizQuestions` - 選択式問題10問（4択）
- `ProgressBar` - 進捗バー（10問中X問）
- `ResultDisplay` - 結果表示（正答率、間違えた語彙）

#### PROGRESS画面
- `AttemptsList` - タスク履歴（最新10件）
- `AverageBand` - 平均Band（rangeで可）
- `WeaknessTrend` - 弱点タグ推移（テキストのみ、グラフ不要）

---

## 技術スタック詳細

### フロントエンド
- **Next.js 14+** (App Router)
- **TypeScript**
- **Tailwind CSS** (スタイリング)
- **shadcn/ui** (UIコンポーネント)
- **React Hook Form** (フォーム管理)
- **Zod** (バリデーション)

### バックエンド
- **Next.js Route Handlers** (API)
- **Supabase** (Auth, Postgres, Storage)
- **OpenAI API** または **Anthropic API** (LLM)

### その他
- **Vercel** (デプロイ)
- **GitHub Actions** (CI/CD)

---

## 実装の優先順位（縦スライスベース）

### 縦スライス1: Login → Home → Task → Submit → Feedback → Progress（最優先）
- 認証機能
- HOME画面（推奨タスク、弱点タグ）
- TASK画面（お題、レベル別入力、必須語彙）
- タスク生成API
- 回答送信API
- フィードバック生成API
- FEEDBACK画面（Band推定、4次元評価、Band-up actions）
- PROGRESS画面（履歴一覧、弱点タグ推移テキスト）
- 進捗トラッキング（daily_state更新）

### 縦スライス2: Fill-in → Feedback反映
- FILL_IN画面（選択式、最大3問）
- 穴埋め問題生成
- 穴埋め回答送信API
- フィードバック反映ロジック

### 縦スライス3: Rewrite → Re-evaluate → Feedback更新
- REWRITE画面（2カラム表示、指定範囲のみ編集）
- 書き直し送信API
- 再評価API（rewrite_coach）
- フィードバック更新表示

### 縦スライス4: Vocab → 今日の必須語彙連動
- VOCAB画面（選択式10問）
- 単語問題生成API
- 単語学習ログ保存
- 必須語彙連動機能

### 縦スライス5: Speak（テキストプロンプトのみ）
- SPEAK画面（2分要約、Follow-up 5問、必須語彙）
- Speakingプロンプト生成API（writing_to_speaking）
- ※録音機能はPhase2

---

## コスト対策

### LLM呼び出しの最適化
1. **タスク生成**: キャッシュ可能（同じレベル・お題なら再利用）
2. **フィードバック**: 同じ回答内容なら再利用（`response_id`をキーに）
3. **プロンプト最適化**: トークン数を最小化
4. **バッチ処理**: 可能な限り非同期処理

### データベース最適化
1. **インデックス**: 頻繁にクエリするカラムにインデックス
2. **RLS**: セキュリティとパフォーマンスのバランス
3. **接続プール**: Supabaseの接続プールを活用

---

## 次のステップ（実装開始時）

### 1. プロジェクトセットアップ
- Next.js 14+ (App Router) + TypeScript プロジェクト作成
- Supabase プロジェクト作成・接続
- 環境変数設定（Supabase URL/Key, OpenAI API Key）

### 2. データベーステーブル作成
- `05_DBテーブル設計_最小構成.md` のDDLを実行
- RLSポリシー設定
- 初期データ投入（vocab_items）

### 3. 共通基盤実装
- 共通レイアウト（Header/Footer）
- APIレスポンス統一フォーマット（`ApiResponse<T>`）
- LLM呼び出し共通関数（`lib/llm/client.ts`）
- TypeScript型定義（`types/index.ts`）

### 4. 縦スライス1実装（最優先）
- 認証機能（Supabase Auth）
- HOME画面
- TASK画面
- タスク生成API（`task_generate`プロンプト）
- 回答送信API
- フィードバック生成API（`writing_feedback`プロンプト）
- FEEDBACK画面
- PROGRESS画面
- 進捗トラッキング

### 5. 縦スライス2〜5を順次実装
- 各縦スライスを完成させてから次へ進む
- 横に広げず、縦に深める

