# データベース設計（Supabase Postgres - 最小構成）

## テーブル一覧（8テーブル）

### 1. profiles（ユーザープロファイル）

```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  initial_level TEXT NOT NULL CHECK (initial_level IN ('beginner', 'intermediate', 'advanced')),
  current_level TEXT, -- 推定レベル（進捗に基づく）
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_profiles_email ON profiles(email);
```

### 2. tasks（タスク・お題）

```sql
CREATE TABLE tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  level TEXT NOT NULL CHECK (level IN ('beginner', 'intermediate', 'advanced')),
  question TEXT NOT NULL, -- IELTS形式のお題
  question_type TEXT DEFAULT 'Task 2',
  required_vocab JSONB, -- [{word, meaning, skill_tags}]
  prep_guide JSONB, -- PREPガイド（初級/中級用）
  created_at TIMESTAMPTZ DEFAULT NOW(),
  is_cached BOOLEAN DEFAULT FALSE,
  cache_key TEXT
);

CREATE INDEX idx_tasks_level ON tasks(level);
CREATE INDEX idx_tasks_cache_key ON tasks(cache_key);
```

### 3. attempts（ユーザーの回答）

```sql
CREATE TABLE attempts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  level TEXT NOT NULL CHECK (level IN ('beginner', 'intermediate', 'advanced')),
  draft_content JSONB, -- {japanese?: string, skeleton?: string, fill_in?: string, final?: string}
  submitted_at TIMESTAMPTZ,
  status TEXT DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'rewritten')),
  rewrite_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_attempts_user_id ON attempts(user_id);
CREATE INDEX idx_attempts_task_id ON attempts(task_id);
CREATE INDEX idx_attempts_submitted_at ON attempts(submitted_at);
```

### 4. feedbacks（フィードバック）

```sql
CREATE TABLE feedbacks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  attempt_id UUID NOT NULL REFERENCES attempts(id) ON DELETE CASCADE,
  overall_band_range TEXT NOT NULL, -- "6.0-6.5"
  dimensions JSONB NOT NULL, -- DimensionFeedback[]
  strengths JSONB NOT NULL, -- Strength[]
  band_up_actions JSONB NOT NULL, -- BandUpAction[] (最大3つ)
  rewrite_targets JSONB NOT NULL, -- RewriteTarget[] (最大2箇所)
  vocab_suggestions JSONB NOT NULL, -- VocabSuggestion[]
  metadata JSONB NOT NULL, -- FeedbackMetadata
  created_at TIMESTAMPTZ DEFAULT NOW(),
  parent_feedback_id UUID REFERENCES feedbacks(id), -- 書き直しの場合
  is_rewrite BOOLEAN DEFAULT FALSE
);

CREATE INDEX idx_feedbacks_attempt_id ON feedbacks(attempt_id);
CREATE INDEX idx_feedbacks_parent_id ON feedbacks(parent_feedback_id);
```

### 5. revisions（書き直し履歴）

```sql
CREATE TABLE revisions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  attempt_id UUID NOT NULL REFERENCES attempts(id) ON DELETE CASCADE,
  feedback_id UUID NOT NULL REFERENCES feedbacks(id) ON DELETE CASCADE,
  revised_content JSONB NOT NULL, -- {target_id: string, original_text: string, revised_text: string}
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_revisions_attempt_id ON revisions(attempt_id);
CREATE INDEX idx_revisions_feedback_id ON revisions(feedback_id);
```

### 6. vocab_items（語彙マスタ）

```sql
CREATE TABLE vocab_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  word TEXT NOT NULL,
  meaning TEXT NOT NULL,
  skill_tags TEXT[] NOT NULL, -- ['writing', 'speaking', 'reading', 'listening']
  example_sentence TEXT,
  collocations JSONB, -- [{word, context}]
  level TEXT CHECK (level IN ('beginner', 'intermediate', 'advanced')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(word)
);

CREATE INDEX idx_vocab_items_word ON vocab_items(word);
CREATE INDEX idx_vocab_items_level ON vocab_items(level);
```

### 7. vocab_logs（語彙学習ログ）

```sql
CREATE TABLE vocab_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  vocab_id UUID NOT NULL REFERENCES vocab_items(id) ON DELETE CASCADE,
  session_date DATE NOT NULL,
  questions JSONB NOT NULL, -- [{vocab_id, question_type, question, options}]
  answers JSONB NOT NULL, -- [{question_id, user_answer, is_correct}]
  score INTEGER, -- 正答数
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_vocab_logs_user_id ON vocab_logs(user_id);
CREATE INDEX idx_vocab_logs_session_date ON vocab_logs(session_date);
```

### 8. daily_state（今日の状態）

```sql
CREATE TABLE daily_state (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  recommended_task_id UUID REFERENCES tasks(id),
  required_vocab JSONB, -- [{vocab_id, word, meaning}] 今日の必須語彙
  weakness_tags TEXT[], -- ['TR', 'CC', 'LR', 'GRA'] 上位1〜2
  latest_band_estimate TEXT, -- "6.0-6.5"
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, date)
);

CREATE INDEX idx_daily_state_user_date ON daily_state(user_id, date);
```

---

## Row Level Security (RLS) 方針（最小ルール）

```sql
-- 全テーブルでRLSを有効化
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE attempts ENABLE ROW LEVEL SECURITY;
ALTER TABLE feedbacks ENABLE ROW LEVEL SECURITY;
ALTER TABLE revisions ENABLE ROW LEVEL SECURITY;
ALTER TABLE vocab_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE vocab_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE daily_state ENABLE ROW LEVEL SECURITY;

-- 基本ポリシー: user_id = auth.uid() のみ許可

-- profiles: 自分のみ
CREATE POLICY "Users can manage own profile" ON profiles
  FOR ALL USING (auth.uid() = id);

-- tasks: 全員閲覧可能（生成済みタスク）
CREATE POLICY "Anyone can view tasks" ON tasks
  FOR SELECT USING (true);

-- attempts: 自分のみ
CREATE POLICY "Users can manage own attempts" ON attempts
  FOR ALL USING (auth.uid() = user_id);

-- feedbacks: 自分のattemptに関連するもののみ
CREATE POLICY "Users can view own feedbacks" ON feedbacks
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM attempts
      WHERE attempts.id = feedbacks.attempt_id
      AND attempts.user_id = auth.uid()
    )
  );

-- revisions: 自分のattemptに関連するもののみ
CREATE POLICY "Users can manage own revisions" ON revisions
  FOR ALL USING (
    EXISTS (
      SELECT 1 FROM attempts
      WHERE attempts.id = revisions.attempt_id
      AND attempts.user_id = auth.uid()
    )
  );

-- vocab_items: 全員閲覧可能
CREATE POLICY "Anyone can view vocab items" ON vocab_items
  FOR SELECT USING (true);

-- vocab_logs: 自分のみ
CREATE POLICY "Users can manage own vocab logs" ON vocab_logs
  FOR ALL USING (auth.uid() = user_id);

-- daily_state: 自分のみ
CREATE POLICY "Users can manage own daily state" ON daily_state
  FOR ALL USING (auth.uid() = user_id);
```

---

## データモデル関係図

```
profiles (1) ──< (N) attempts
                │
                ├──< (N) feedbacks
                │      │
                │      └──< (N) revisions
                │
                └──< (N) vocab_logs
                          │
                          └──> (1) vocab_items

profiles (1) ──< (N) daily_state
                │
                └──> (1) tasks (recommended_task_id)

tasks (1) ──< (N) attempts
```

---

## 主要なクエリパターン

### 今日の推奨タスク取得
```sql
SELECT t.*
FROM tasks t
JOIN daily_state ds ON ds.recommended_task_id = t.id
WHERE ds.user_id = $1 AND ds.date = CURRENT_DATE;
```

### ユーザーの最新フィードバック取得
```sql
SELECT f.*
FROM feedbacks f
JOIN attempts a ON a.id = f.attempt_id
WHERE a.user_id = $1
ORDER BY f.created_at DESC
LIMIT 1;
```

### 今日の必須語彙取得
```sql
SELECT vi.*
FROM vocab_items vi
JOIN daily_state ds ON vi.id = ANY(
  SELECT jsonb_array_elements(ds.required_vocab)->>'vocab_id'::uuid
)
WHERE ds.user_id = $1 AND ds.date = CURRENT_DATE;
```

### 弱点タグ推移（テキスト表示用）
```sql
SELECT 
  date,
  weakness_tags,
  latest_band_estimate
FROM daily_state
WHERE user_id = $1
ORDER BY date DESC
LIMIT 10;
```

---

## マイグレーション順序

1. `profiles` - ユーザープロファイル
2. `tasks` - タスク（生成済み）
3. `vocab_items` - 語彙マスタ（初期データ投入）
4. `attempts` - ユーザー回答
5. `feedbacks` - フィードバック
6. `revisions` - 書き直し履歴
7. `vocab_logs` - 語彙学習ログ
8. `daily_state` - 今日の状態

RLSポリシーは各テーブル作成後に設定。

